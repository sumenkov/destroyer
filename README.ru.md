# destroyer (Rust)

> ⚠️ **ОПАСНО**: Утилита безвозвратно перезаписывает указанный блок‑девайс. Проверьте путь `/dev/...` и убедитесь, что устройство **размонтировано**.  
> **Поддерживаемые ОС:** только Linux и macOS.

[English](./README.md) · [中文](./README.zh-CN.md)

---

## Содержание
- [Что это](#что-это)
- [Важные предупреждения](#важные-предупреждения)
- [Поддерживаемые платформы](#поддерживаемые-платформы)
- [Установка Rust и Cargo](#установка-rust-и-cargo)
- [Сборка](#сборка)
- [Запуск](#запуск)
- [Режимы](#режимы)
- [Примеры](#примеры)
- [Размонтирование / освобождение устройства](#размонтирование--освобождение-устройства)
- [Тюнинг и производительность](#тюнинг-и-производительность)
- [Диагностика](#диагностика)
- [Лицензия](#лицензия)

## Что это
`destroyer` — безопасная утилита для многопроходного стирания **блочных устройств**. Несколько проходов случайными данными из `/dev/urandom`, затем финальный проход нулями.

- На **каждом проходе** генерируется новый случайный буфер.
- Финальный проход — **нули**.
- Корректное определение размера устройства на Linux/macOS.

## Важные предупреждения
- Запуск по неверному устройству **навсегда уничтожит** данные.
- Всегда сначала размонтируйте устройство.
- Предпочтительно работать по **всему диску** (`/dev/sdX`, `/dev/nvme0n1`, `/dev/diskN`), а не по смонтированному разделу.
- Нужны права суперпользователя (`sudo`).

## Поддерживаемые платформы
- **Linux** — поддерживается.
- **macOS** — поддерживается.
- **Windows / прочие** — не поддерживаются.

## Установка Rust и Cargo
**Рекомендуется (rustup):**
```bash
# Linux / macOS:
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
# затем перезагрузите shell или:
source $HOME/.cargo/env
rustc --version && cargo --version
```

**macOS через Homebrew (опционально):**
```bash
brew install rustup-init
rustup-init -y
source $HOME/.cargo/env
```

## Сборка
```bash
cargo build --release
```

## Запуск
```bash
sudo target/release/destroyer <устройство> [проходы] [--mode fast|durable] [--buf BYTES]
```

### Параметры
- `<устройство>` — путь к блочному устройству (Linux: `/dev/sdX`, `/dev/nvme0n1`; macOS: `/dev/diskN`).
- `[проходы]` — количество проходов, по умолчанию **8** (последний — нулями).
- `--mode` — `fast` (по умолчанию) или `durable` (см. ниже).
- `--buf BYTES` — размер буфера записи. Если не указан — выбирается **автоматически**
  по размеру блока устройства (кратно сектору; целимся ~64 KiB в диапазоне 16 KiB..1 MiB).

## Режимы
- `fast` — приоритет скорость.
- `durable` — повышенная надёжность:
  - **Linux**: открываем с `O_SYNC` (каждый `write()` ждёт устойчивой записи).
  - **macOS**: отключаем кеш (`F_NOCACHE`) и делаем «жёсткий» flush `F_FULLFSYNC` в конце каждого прохода.

## Автовыбор буфера
На Linux читаем `/sys/class/block/<dev>/queue/{logical_block_size,physical_block_size}`.
На macOS используем `DKIOCGETBLOCKSIZE`. Буфер выбирается кратным
`max(logical, physical)` с целевым значением **~64 KiB** (ограничения **16 KiB..1 MiB**).
Если задан `--buf`, значение нормализуется до кратности сектору и также ограничивается диапазоном.

## Примеры
```bash
sudo target/release/destroyer /dev/sdX
sudo target/release/destroyer /dev/sdX 5 --mode durable --buf 65536
sudo target/release/destroyer /dev/diskN 3 --mode fast
```

## Размонтирование / освобождение устройства
**macOS**
```bash
diskutil unmountDisk /dev/diskN
```

**Linux**
```bash
sudo umount <точка_монтирования_или_/dev/...>
# Найти привязки:
lsblk -f | grep $(basename /dev/sdX)
# Кто держит:
sudo lsof /dev/sdX | head
sudo fuser -mv /dev/sdX
# Если это swap:
sudo swapoff -a
# LVM / dm-crypt:
sudo dmsetup ls
```

## Тюнинг и производительность
- Увеличьте `--buf` до 64KiB или 1MiB, если носитель лучше пишет крупными блоками.
- Режим `durable` будет **заметно медленнее** (из-за барьеров/flush).
- На macOS предпочтительнее узлы всего диска (`/dev/diskN`).

## Диагностика
- **`EBUSY` (занято):** устройство смонтировано или занято процессом — см. раздел о размонтировании.
- **`Inappropriate ioctl for device` при синхронизации:** часть сырых устройств не поддерживает `fsync` — в коде есть безопасные обходы.
- **Permission denied:** запускайте через `sudo`.

## Лицензия
MIT. Переводы для удобства:
- [LICENSE (англ.)](./LICENSE)
- [LICENSE.ru (рус., неофиц.)](./LICENSE.ru)
- [LICENSE.zh-CN (кит., неофиц.)](./LICENSE.zh-CN)
